<!-- [if cgi mv_more_ip]
[calc]
	for( qw/
		help_name
		icon_name
		mv_data_table
		page_title
		ui_break_before
		ui_show_fields
		ui_sort_field
		ui_sort_option
		ui_description_fields
		ui_flex_description
		ui_flex_key
		page_banner
		/)
	{
		$CGI->{$_} = $Values->{$_};
		push @out, "$_ = $CGI->{$_}";
	}
	return join "\n", @out;
[/calc]
[/if] -->

[tmp page_title]
	[either]
		[cgi page_title]
	[or]
		Select for table edit: [cgi mv_data_table]
	[/either]
[/tmp]
[tmp page_banner]
	[either]
		[cgi page_banner]
	[or]
		[cgi page_title]
	[or]
		[loop list="[cgi mv_data_table]"]
		Select for table edit:
		[page href="__UI_BASE__/flex_editor"
				 form='
				 mv_data_table=__UI_META_TABLE__
				 ui_meta_view=dbconfig
				 ui_data_fields=code name height field options attribute width type display_filter help help_url
				 ui_break_before=height display_filter
				 page_title=Change display information: [loop-code]
				 ui_return_to=__UI_BASE__/gentable
				 ui_return_stack=1
				 item_id=[loop-code]
		 '][loop-code]</A>
		[/loop]
	[/either]
[/tmp]
[tmp help_name][either][cgi help_name][or]flex.select[/either][/tmp]
[tmp icon_name][either][cgi icon_name][or]admin/icon_config.gif[/either][/tmp]

[if cgi mv_return_table]
	[calc]
		$CGI->{mv_data_table} = delete $CGI->{mv_return_table};
		return;
	[/calc]
[/if]

[if-mm function="!tables" table="[cgi mv_data_table]"]
[bounce page="__UI_BASE__/error"]
[/if-mm]

<!-- sequence_edit: [cgi ui_sequence_edit] -->
<!-- item_id_left: [cgi item_id_left] -->
[perl tables="[cgi mv_data_table] __UI_META_TABLE__"]
	delete $Scratch->{ui_location};
	if($CGI->{ui_sequence_edit}) {
		my $doit;
		if($CGI->{item_id_left} =~ s/^(.*?),//) {
			$CGI->{item_id} = $1;
			$doit = 1;
		}
		elsif ($CGI->{item_id_left}) {
			$CGI->{item_id} = delete $CGI->{item_id_left};
			delete $CGI->{ui_sequence_edit};
			$doit = 1;
		}
		else {
			delete $CGI->{item_id};
			delete $CGI->{ui_sequence_edit};
		}
		return unless $doit;
		$Scratch->{ui_location}
				= $Tag->area( {
						href => '__UI_BASE__/flex_editor',
						form => qq{
							mv_data_table=$CGI->{mv_data_table}
							item_id=$CGI->{item_id}
							item_id_left=$CGI->{item_id_left}
							ui_sequence_edit=$CGI->{ui_sequence_edit}
							ui_return_to=__UI_BASE__/flex_select
							ui_return_to=mv_data_table=$CGI->{mv_data_table}
							ui_return_to=ui_sequence_edit=$CGI->{ui_sequence_edit}
							ui_page_banner=Edit next key $CGI->{item_id}
						},
					});
		return;
	}

	return unless $CGI->{item_id};
	return unless delete $CGI->{deleterecords};
	return unless $Tag->if_mm('tables', '=d');

	delete $Scratch->{ui_location};
	$Config->{NoSearch} = '';
	my $tab = $CGI->{mv_data_table} or return;
	my $db = $Db{$tab};
	if(! $db) {
		$Scratch->{error_message} = "<FONT CLASS=error>Error: no <B>$tab</B> database.</FONT><BR>";
		$Scratch->{ui_location} = "__UI_BASE__/error";
		return;
	}

	for(grep $_, @{$CGI_array->{item_id}}) {
		$db->delete_record($_)
			or push @errors, $@;
	}
	if(@errors) {
		my $plural = @errors > 1 ? 's' : '';
		return "<FONT CLASS=error>Error$plural:<UL><LI>" .
				join ("<LI>", @errors)                    .
				"</UL></FONT><BR>";
	}
	return;
[/perl]

<!-- ui_location: [scratch ui_location] -->
[if scratch ui_location]
[bounce href=`delete $Scratch->{ui_location}`]
[elsif !cgi mv_data_table]
[bounce page="__UI_BASE__/gentable"]
[/elsif]
[/if]

@_UI_STD_HEAD_@
[update values]
<!-- ----- BEGIN REAL STUFF ----- -->
<FORM ACTION="[area @@MV_PAGE@@]" METHOD=GET>
<INPUT TYPE=hidden NAME=mv_data_table    VALUE="[cgi mv_data_table]">
<INPUT TYPE=hidden NAME=mv_action        VALUE=back>
<INPUT TYPE=hidden NAME=ui_show_fields VALUE="[cgi ui_show_fields]">

<table>
<tr>
<td>
		[loop list="[cgi mv_data_table]"]
		 	[if-loop-data __UI_META_TABLE__ name]
		 	<B>[loop-data __UI_META_TABLE__ name]</B>
			[/if-loop-data]
		 	[if-loop-data __UI_META_TABLE__ help_url]
		 	&nbsp;&nbsp;&nbsp;<small><A HREF="[loop-data __UI_META_TABLE__ help_url]">help</A></small>
			[/if-loop-data]
		 	[if-loop-data __UI_META_TABLE__ help]
		 	<BR><i>[loop-data __UI_META_TABLE__ name]</i>
			[/if-loop-data]
		[/loop]
</td>
<td>
<input NAME=ui_text_qualification size=16><INPUT TYPE=submit VALUE="Limit with search">
</td>
</tr>
</table>
</FORM>
[if scratch ui_failure]
<P>
<BLOCKQUOTE>
<FONT COLOR="__CONTRAST__">[scratch ui_failure][set ui_failure][/set]</FONT>
</BLOCKQUOTE>
<P>
&nbsp;
[/if]
[if scratch ui_message]
<P>
<BLOCKQUOTE>
<FONT COLOR="__CONTRAST__">[scratch ui_message][set ui_message][/set]</FONT>
</BLOCKQUOTE>
<P>
&nbsp;
[/if]

[perl tables="[cgi mv_data_table] __UI_META_TABLE__"]
	my $ref = $Db{$CGI->{mv_data_table}};
	my $mref = $Db{__UI_META_TABLE__};
	
	if (! $ref) {
		$Scratch->{keypos} = 0;
		return;
	}
	elsif (! $mref) {
		$Scratch->{keypos} = 0;
	}

	my $meta;
	if($mref and $mref->record_exists($CGI->{mv_data_table}) ) {
		$meta = $mref->row_hash($CGI->{mv_data_table});
	}
	else {
		$meta = {};
	}
	if($CGI->{ui_flex_key}) {
		$Scratch->{keypos} = $CGI->{ui_flex_key};
	}
	else {
		$Scratch->{keypos} = $ref->config('KEY_INDEX');
	}
	$Scratch->{keyname} = $ref->config('KEY');

	$Config->{NoSearch} = '';
	$ui_text_qualification = $CGI->{ui_text_qualification};
	if ($ui_text_qualification and $CGI->{ui_text_qualification} =~ /[<!=>\^]/ ) {
		$CGI->{ui_text_qualification} = "co=1\n";

		my @entries = split /\s+(and|or)\s+/i,  $ui_text_qualification;
		my $or;
		for(@entries) {
			if(/^or$/i) {
				$or = 1;
				$CGI->{ui_text_qualification} .= "os=1\n";
				next;
			}
			elsif(/^and$/i) {
				$or = 0;
				$CGI->{ui_text_qualification} .= "os=0\n";
				next;
			}
			my ($f, $op, $s) = split /\s*([<=!>\^]+)\s*/, $_, 2;
			$op = "eq" if $op eq "==";
			$op = "rm" if $op eq "=";
			if($op eq '^') {
				$op = 'rm';
				$CGI->{ui_text_qualification} .= "bs=1\nsu=1\n";
			}
			else {
				$CGI->{ui_text_qualification} .= "bs=0\nsu=0\n";
			}
			$CGI->{ui_text_qualification} .= "se=$s\nsf=$f\nop=$op\n";
			if($op =~ /[<>]/ and $s =~ /^[\d.]+$/) {
				$CGI->{ui_text_qualification} .= "nu=1\n";
			}
			else {
				$CGI->{ui_text_qualification} .= "nu=0\n";
			}
		}
		if(defined $or) {
			$CGI->{ui_text_qualification} .= $or ? "os=1\n" : "os=0\n";
		}

		$out_message =  <<EOF;
<H3>Entries matching "$ui_text_qualification"</H3>
EOF
	}
	elsif ($ui_text_qualification) {
		$CGI->{ui_text_qualification} = "se=$CGI->{ui_text_qualification}";
		$out_message =  <<EOF;
<H3>Entries matching "$CGI->{ui_text_qualification}"</H3>
EOF
	}
	else {
		$CGI->{ui_text_qualification} = "ra=yes";
	}
	$CGI->{ui_sort_field} = $meta->{lookup} || $Scratch->{keyname}
		if ! $CGI->{ui_sort_field};
	$CGI->{ui_list_size} = $meta->{height}
		if ! $CGI->{ui_list_size};

	if(! ($CGI->{ui_show_fields} ||= $meta->{field}) ) {
		$CGI->{ui_show_fields} = 
			$CGI->{ui_description_fields}
				= join ",", $ref->columns();
	}
	else {
		my $i = 0;
		my $show = $CGI->{ui_show_fields};
		$show =~ s/(\w+)(?:\((.*?)\))?/ ($filter_show[$i++] = $2), $1/eg;
#Log("filter_show: " . $Tag->uneval( { ref => \@filter_show } ));
		$show =~ s/[\0,\s]+/,/g;
		$CGI->{ui_description_fields} = $show;
	}

	@cols = grep $ref->column_exists($_), 
				split /,/, $CGI->{ui_description_fields};

	my %limit_field;

	$CGI->{ui_limit_fields} =~ s/[\0,\s]+/ /g;
	$CGI->{ui_limit_fields} =~ s/^\s+//;
	$CGI->{ui_limit_fields} =~ s/\s+$//;

	my (@limit_field) = split " ", $CGI->{ui_limit_fields};

#Log("show_field: " . $Tag->uneval( { ref => \@cols } ));
#Log("cols ary:   " . $Tag->uneval( { ref => \@cols } ));
#Log("limit_fields ary: " . $Tag->uneval( { ref => \@limit_field } ));
	if(@limit_field) {
#Log("limit_fields ary: " . $Tag->uneval( { ref => \@limit_field } ));
		@limit_field{@limit_field} = ();
#Log("limit_fields: " . $Tag->uneval( { ref => \%limit_field } ));
		@cols = grep ! exists($limit_field{$_}), @cols;
#Log("cols ary:   " . $Tag->uneval( { ref => \@cols } ));
	}

	unshift(@cols, $Scratch->{keyname})
		if $cols[0] ne $Scratch->{keyname};

	for(@cols) {
		$numeric{$_} = 1 if $ref->numeric($_);
	}

	$CGI->{ui_description_fields} = join ",", @cols;

	$Scratch->{sparams} = <<EOF;

	fi=$CGI->{mv_data_table}
	st=db
	$CGI->{ui_text_qualification}
	su=1
	md=1
	ml=$CGI->{ui_list_size}
	tf=$CGI->{ui_sort_field}
	to=$CGI->{ui_sort_option}
	rf=$CGI->{ui_description_fields}

EOF
	return $out_message;
[/perl]
</FORM>

<!-- tq: [scratch sparams] -->
<TABLE CELLSPACING=1 cellmargin=3>
<FORM ACTION="[area @@MV_PAGE@@]" METHOD=POST>
<INPUT TYPE=hidden NAME=mv_data_table    VALUE="[cgi mv_data_table]">
[if cgi ui_meta_view]
[return-to]
[else]
<INPUT TYPE=hidden NAME=ui_meta_specific VALUE="[cgi ui_meta_specific]">
<INPUT TYPE=hidden NAME=ui_page_title    VALUE="[cgi ui_page_title]">
<INPUT TYPE=hidden NAME=ui_page_title    VALUE="[cgi ui_page_banner]">
<INPUT TYPE=hidden NAME=ui_meta_specific VALUE="[cgi ui_meta_specific]">
<INPUT TYPE=hidden NAME=ui_limit_fields VALUE="[cgi ui_limit_fields]">
<INPUT TYPE=hidden NAME=ui_show_fields VALUE="[cgi ui_show_fields]">
<INPUT TYPE=hidden NAME=ui_return_to     VALUE="@@MV_PAGE@@">
<INPUT TYPE=hidden NAME=ui_return_to     VALUE="mv_data_table=[cgi mv_data_table]">
<INPUT TYPE=hidden NAME=ui_return_to     VALUE="ui_sequence_edit=1">
[/else]
[/if]
<INPUT TYPE=hidden NAME=mv_action        VALUE=back>
<TR BGCOLOR="__UI_C_TITLEBARBG__">
[loop list="[cgi ui_description_fields]"]
<TH[loop-calc]
			my $extra = '';
			while ($filter_show[ [loop-increment] - 1] =~ m/\b(v?align\s*=\w+)/gi) {
				$extra .= " $1";
			}
			return $extra || ' ALIGN=LEFT';
		[/loop-calc]><FONT COLOR="__UI_C_TITLEBARTXT__">
	[loop-change 1][condition]1[/condition]&nbsp;&nbsp;&nbsp;&nbsp;[/loop-change 1]
	<A HREF="[area href='__UI_BASE__/flex_group'
					form='
						mv_data_table=[cgi mv_data_table]
						mv_arg=[loop-code]
					'
				]"><IMG ALT="select by [loop-code]" SRC="@_UI_IMG_@admin/smindex.gif" BORDER=0></A></TH>
[/loop]
</tr>
<TR BGCOLOR="__UI_C_TITLEBARBG__">
[loop list="[cgi ui_description_fields]"]
<TH ALIGN=LEFT><FONT COLOR="__UI_C_TITLEBARTXT__">
	[loop-change 1][condition]1[/condition]&nbsp;&nbsp;&nbsp;&nbsp;[/loop-change 1]
	<A HREF="[area href='@@MV_PAGE@@'
					form=`
						my $f = '[loop-code]';
						my $o = '';
						$o .= 'r'
							if $CGI->{ui_sort_field} eq $f
									and
								$CGI->{ui_sort_option} !~ /r/;
						$o .= 'n' if $numeric{$f};
						return qq(
							ui_text_qualification=$ui_text_qualification
							mv_data_table=$CGI->{mv_data_table}
							ui_sort_field=$f
							ui_sort_option=$o
						);
					`
				]">[loop-code]</TH>
[/loop]
</tr>
[tmp tmp_url]
	mv_data_table=[cgi mv_data_table]
	ui_page_title=[cgi ui_page_title]
	ui_page_banner=[cgi ui_page_banner]
	ui_meta_specific=[cgi ui_meta_specific]
	[if cgi ui_return_to]
	[and !cgi ui_return_stack]
		[return-to formlink]
	[else]
		ui_return_to=@@MV_PAGE@@
	[/else]
	[/if][/tmp]
[search-region more=1 arg="[scratch sparams]"]
[search-list]
<TR [item-alternate 2]BGCOLOR="__UI_T_ROW_EVEN__"[else]BGCOLOR="__UI_T_ROW_ODD__"[/else][/item-alternate]>

<TD><INPUT TYPE=checkbox NAME=item_id VALUE="[item-code]">&nbsp;&nbsp;[page href=__UI_BASE__/flex_editor form=|
							[scratch tmp_url]
							item_id=[item-code]
						|][item-code]</A></TD>
[item-sub show_line]
sub {
	my ($pre, $post) = split /\t/, shift;
	my $line = shift;
	return unless $line;
	shift (@$line);
	my $out = '';
	my $i = 1;
	for(@$line) {
		my $filter = $filter_show[$i] || 'entities';
		my $extra = '';

		$extra .= " $1" while $filter =~ s/(v?align=\w+)//i;
#Log("$i filter = $filter");

		s/\[/&#91;/g;
		$out .= "<TD$extra>" . $Tag->filter($filter, $_) . "</TD>";
		$i++;
	}
	return $out . "\n";
}
[/item-sub]
[item-exec show_line][/item-exec]
</tr>
[/search-list]
[no-match]
<tr>
<td colspan=6 align=center>
<B>Nothing matched.</B>
</td>
</tr>
[/no-match]
[more-list]
<tr>
<td colspan=6 align=center>
More rows: [decade-next][/decade-next] [more] [decade-prev][/decade-prev]
</td>
</tr>
[/more-list]
</table>

[if !cgi ui_meta_view]
[button text="Edit checked records in sequence"]
ui_sequence_edit=[calc]
	$CGI->{item_id_left} = $CGI->{item_id};
	$CGI->{item_id_left} =~ s/\0+/,/g;
	if($CGI->{item_id_left} =~ s/^(.*?),//) {
		$CGI->{item_id} = $1;
		return 1;
	}
	else {
		delete $CGI->{item_id_left};
		return '';
	}
[/calc]
mv_nextpage=__UI_BASE__/flex_editor
mv_todo=return
[/button]
[/if]

&nbsp;&nbsp;&nbsp;&nbsp;

[button text="Delete checked records"
		confirm="Are you sure you want to delete the checked records?"]
[flag type=write table="[cgi mv_data_table]"]
deleterecords=1
mv_click=db_maintenance
[/button]
</FORM>
[/search-region]
<!-- ----- END REAL STUFF ----- -->

@_UI_STD_FOOTER_@
<!-- page: @@MV_PAGE@@ -->
