[set page_title]Edit Template[/set]
[set ui_class]Content[/set]
[set help_name]page.main[/set]
[set icon_name]admin/icon_pages.gif[/set]
@_UI_STD_HEAD_@

<!-- ----- BEGIN REAL STUFF ----- -->

<form action="[area @@MV_PAGE@@]" method=POST ENCTYPE="multipart/form-data">
<input type=hidden name=mv_action value=back>

<table __UI_T_PROPERTIES__>
<tr id=rborder>
<td colspan=2>
<img src="@_UI_IMG_@admin/bg.gif" height=1>
</td>
</tr>

[perl tables="[list-databases] __UI_META_TABLE__"] 

	# Some inits
	my $imgpath = $Tag->var('UI_IMG', 1) || $Variable->{UI_IMG} || '';
	my $template_dir = $Variable->{UI_TEMPLATE_DIR} || 'templates';
	my $out = '';

	$CGI->{ui_show_template} = 1 unless defined $CGI->{ui_show_template};

	sub bleach_it {
		my $val = shift;
		$val =~ s:.*/::;
		$val =~ s/\W+/_/g;
		$val =~ s/_+/_/g;
		return lc($val);
	}

	sub tmp_error {
		my $msg = errmsg(@_);
		my $messages = join "\n--message--\n", @messages;
		return <<EOF;
<TR class=rerror><td colspan=2 class=cerror>$msg</td></tr>
<TR class=rerror><td colspan=2 class=cerror><XMP>$messages</XMP></td></tr>
EOF
	}

	# Probably should offload this to mv_click=process_filter
	my @filters = grep /^ui_filter:/, keys %$CGI;
	foreach my $key (@filters) {
		my $val = delete $CGI->{$key};
		$key =~ s/ui_filter://;
		next unless $val;
		next unless defined $CGI->{$key};
		$CGI->{$key} = $Tag->filter($val, $CGI->{$key}, $key);
	}

	my $new;
	if($CGI->{ui_template_new}) {
#Debug("found new template");
		$t_desc = $CGI->{ui_template_description} || $CGI->{ui_template_new};
		$t_name = bleach_it($CGI->{ui_template_new});
		$new = 1;
	}
	else {
		$t_name = bleach_it($CGI->{ui_template});
	}

	my $t_file = "$template_dir/$t_name";

	push @messages, "template: $t_name; t_file=$t_file";

	### Add some code here to check for existing templates...
	
	my $exists = -f $t_file;
	my $read_from;

	if($exists and $new) {
		return tmp_error(
				"Template named '%s', already exists, please delete first.",
				$t_name,
				);
	}
	elsif($new and $CGI->{ui_template_template}) {
Debug("reading from example template");
		$read_from = $CGI->{ui_template_template};
		$exists = -f $read_from;
Debug("example template=$read_from exists=$exists");
	}
	elsif($exists) {
Debug("reading from existing template $t_file");
		$read_from = $t_file;
	}

	my $ary;
	my $tref;

	my $name_top = uc($t_name) . "_TOP";
	my $name_bot = uc($t_name) . "_BOTTOM";

	my $template_input;
	TEMPLATE_READ:  {
		if($exists) {
			($ary) = $Tag->read_ui_template($read_from);
			$tref = shift @$ary;
			ref($tref) =~ /HASH/ 
				or return tmp_error(
						"Template read error reading '%s'.",
						$read_from,
					);
			last TEMPLATE_READ;
		}
		$tref = {};
		$tref->{ui_template} = $t_name;
		$tref->{ui_template_name} = $t_name;
		$tref->{ui_template_layout} = "$name_top, UI_CONTENT, $name_bot";
		$tref->{ui_template_description} = $t_desc;

		my $content;
		if( $Values->{ui_upload_template}
			and $Tag->value_extended(
					{
						name => 'ui_upload_template',
						test => 'isfile',
					}
				)
			)							
		{
push @messages, "template from upload:\n$tref->{ui_definition}";
			$template_input = $Tag->value_extended( {
													name => 'ui_upload_template',
													file_contents => 1,
													});
#push @messages, "template from upload is:\n$template_input";
			$template_input =~ s{(.*)(<!--\s+begin\s+content\s+-->)}{$2}is;
			$template_top = $1;
			$template_top =~ s/^\s+//;
			$template_top =~ s/\s+$//;
			$template_input =~ s{(<!--\s+end\s+content\s+-->)\n*(.*)}{$1\n}is;
			$template_bot = $2;
			$template_bot =~ s/^\s+//;
			$template_bot =~ s/\s+$//;
			$content = $template_input;
			$content =~ s/^\s*<!--+\s+begin\s+content\s+--+>(?:\s*\n+)?//i;
			$content =~ s/(?:\n+\s*)?<!--+\s+end\s+content\s+--+>\s*$//i;
			push @messages, "Content:\n$content";
		}
	
   }

	if($exists) {
		my ($top, undef, $bot) = split /\s*,\s*/, $tref->{ui_template_layout};
		my $theme = bleach_it($Variable->{THEME}) || 'default';
		my $rdir = $Variable->{UI_REGION_DIR} || 'regions';
Debug("ref=" . $Tag->uneval( { ref => $tref } ) );
Debug("trying to read: $template_dir/$theme/$rdir/$top");
Debug("trying to read: $template_dir/$theme/$rdir/$bot");
		$template_top = $Tag->file("$template_dir/$theme/$rdir/$top", 'raw');
		$template_bot = $Tag->file("$template_dir/$theme/$rdir/$bot", 'raw');
		$tref->{ui_template_layout} = "$name_top, UI_CONTENT, $name_bot";
		$tref->{ui_template_description} = $t_desc if $t_desc =~ /\S/;
	}

	$t_desc = $tref->{ui_template_description} unless $t_desc;
	$t_desc = $Tag->filter('entities', $t_desc);

#Debug("t_name=$t_name");
	$out .= <<EOF;
<tr>
	<td class=ralt><b>Template Name</b></td>
	<td class=ralt>
		<INPUT TYPE=hidden NAME=ui_template_name VALUE="$t_name">$t_name
	</td>
</tr>
<tr>
	<td class=ralt><b>Template description</b></td>
	<td class=ralt>
		<INPUT SIZE=40 TYPE=text NAME=ui_template_description VALUE="$t_desc">
	</td>
</tr>
<tr>
	<td class=ralt>
		<b>Template sequence</b><br>
	</td>
	<td class=ralt VALIGN=top>
		$tref->{ui_template_layout}
	</td>
</tr>
<tr>
	<td class=ralt colspan=2>
		<small><i>UI_CONTENT is the content portion(s), all others refer
		to Knar elements.</i></small>
	</td>
</tr>
<tr class=rtitle>
<td colspan=2 class=ctitle><img src="${imgpath}admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
EOF

	$content = '' if ! $content;

	$content_display = $content;

	my @comp_order;

	my $compdir = $Variable->{UI_COMPONENT_DIR} || 'templates/components';
	my $cnum = 0;
	my $template_div;

	if( $template_input ) {
		for(\$template_top, \$template_bot) {
			while( $$_ =~ m{
					 [ \t]* 
					 (?:
						<!--+ \s+ begin \s+ component \s+ (\w+) \s+ --+>
						(.*?)
						<!--+ \s+ end \s+ component \s+ \1 \s+ --+> 
					 | 
						\[ include \s+ file \s*=\s*["'][^"]*/
							(?:\[control \s+ component \s+ )?
								(\w+)
							\]? ['"]
						(.*?)
						\]  \s*  \[control\]
					 )
				}gsix)
			{
				my $compname = $1 || $3;
				my $current_content = $2 || $4;
				
				push @comp_order, $compname;

			}

			$$_ =~ s{
					 [ \t]*<!--+
						\s+ begin \s+ component \s+ (\S+) \s+ --+>
						(.*?)
					 <!--+ \s+end \s+component \s+ \1 \s+ --+> 
				}
				{'<!-- COMPONENT #'. ++$cnum . ' -->'}egsix;
			$template_div = $cnum unless $template_div;
		}
	}
	elsif ($template_top) {
		for(\$template_top, \$template_bot) {

			$$_ =~ s{
						\[include\s+
						[^\]]+
						\[control\s+component
						[^\]]+
						\]
						[^\]]*
						\]
						(?:\s*\[control\])?}
				{'<!-- COMPONENT #'. ++$cnum . ' -->'}egsix;
			$template_div = $cnum unless $template_div;
		}
		my $ref = $tref->{ui_display_order} || [];
		@comp_order = @{$ref}[0..$cnum - 1];

	}


	foreach my $compname (@comp_order) {
			# Parens needed for array context
			my ($carray) = $Tag->read_ui_template("$compdir/$compname");
			push @messages, ("Read component $compname=$carray.");
			if ($carray and scalar @$carray) {
				push @cobj, @$carray;
			}
			else {
				my $desc	= -f "$compdir/$compname"
							? 'Static component, no controls'
							: 'placeholder';
				push @cobj, {
					ui_component  => $compname,
					ui_component_name => $compname,
					ui_component_description => $desc,
				};
			}
	}

	$template_top_display = $template_top;
	$template_bot_display = $template_bot;

	my $template_top_widget;
	my $template_bot_widget;
	
	for(\$template_top_display, \$template_bot_display, $content_display) {
		$$_ =~ s/\&/\&amp;/g;
		$$_ =~ s/\[/&#91;/g;
		$$_ =~ s/</&lt;/g;
	}

	$template_top_widget = <<EOF if $CGI->{ui_show_template};
<tr class=cmarq>
<td colspan=2><img src="${imgpath}admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
<tr class=ralt>
	<td colspan=2 valign=top>
	<b>Top of template</b>
	</td>
</tr>

<tr class=ralt>
	<td colspan=2 class=clabel>
		<TEXTAREA NAME=ui_template_top COLS=85 ROWS=20>$template_top_display</TEXTAREA>
	</td>
</tr>
<tr>
<td colspan=2 class=rtitle><img src="${imgpath}admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
EOF


	# Find the current settings
	if($current =~ m/
						\[control \s+ reset \s* = \s* ["']?
							[^0] [^\]]*  \]
						(.*)
						\[control \s+ reset \s* = \s* ["']?
							[^0] [^\]]*  \]
					/six)
	{
		@comp_default = split /\s*\[control\]\s*/, $1;
	}

	my $idx = 0;
	my $num = $idx + 1;

	sub get_unified_ref {
		my ($name, $ref) = @_;
		my $uniref = {};
		for(keys %$ref) {
			next unless ref($ref->{$_}) eq 'HASH';
			$uniref->{$_} = $ref->{$_}{$name} || undef;
		}
		return $uniref;
	}

	my $sep_template = <<EOF;
<tr class=rtitle>
<td colspan=2 class=ctitle>Component #~INCREMENT~ current: ~NAME~ - ~DESC~<INPUT TYPE=hidden NAME="~VARNAME~" VALUE="~NAME~"</td>
</tr>
EOF

	my $break_template = <<EOF;
<tr class=cmarq>
<td colspan=2><img src="${imgpath}admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
EOF

	my $control_template = <<EOF;
<tr>
   <td class=clabel width="$Variable->{UI_LEFT_WIDTH}"> 
     \$LABEL\$~META~
   </td>
   <td class=cdata> 
     <table cellspacing=0 cellmargin=0 width="100%">
       <tr> 
         <td class=cwidget> 
           \$WIDGET\$
         </td>
         <td class=chelp>~TKEY~<i>\$HELP\$</i>{HELPURL}<BR><A HREF="\$HELP_URL\$">help</A>{/HELPURL}</FONT></td>
       </tr>
     </table>
   </td>
</tr>
EOF

#Debug("calling read_ui_template $compdir/*");
	my ($components) = $Tag->read_ui_template("$compdir/*");
	my @copts;
	for(@$components) {
#Debug("Found component: " . uneval($_));
		my $hash = $_;
		my $key = $hash->{ui_component_name} || $hash->{ui_component};
		my $val = $hash->{ui_component_label} || $hash->{ui_component_description};
		$key =~ s/"/&quot;/g;
		$val =~ s/"/&quot;/g;
		$val =~ s/,/&#44;/g;
		push @copts, "$key=$val";
	}

	my $template_break;

	my $opt_string = join ",", "NONE=none", @copts;

	for(my $i = 0; $i < @cobj; $i++) {
		$template_break = scalar(@controls) if $template_div == $i;
		my $ref = $cobj[$i];
		my $c_name = $ref->{ui_component_name} || $ref->{ui_component} || 'None';
		my $c_label  = $ref->{ui_component_label}
					|| $ref->{ui_component_description}
					|| 'no description';
		push @messages, "ui_component_name=$ref->{ui_component_name}";
		push @messages, "ui_component=$ref->{ui_component}";
		push @messages, "ui_component_label=$ref->{ui_component_label}";
		push @messages, "ui_component_description=$ref->{ui_component_description}";

		my @def;

		my $titlebar = $sep_template;
		$titlebar =~ s/~INCREMENT~/$i + 1/eg;
		$titlebar =~ s/~NAME~/$c_name/g;
		$titlebar =~ s/~DESC~/$c_label/g;
		$titlebar =~ s/~VARNAME~/$i.ui_component/g;
		push @controls, $titlebar;
		my $def_string = $ref->{ui_definition};
		$def_string =~ s/"/&quot;/g;

		my $short_def = "ui_component: $c_name";

		my $deftext = $comp_default[$i];

		my $help =<<EOF;
Default component for new page
EOF
		my $r;
#Debug("element=$ref->{element}(or $ref->{element})");

		$widget = $Tag->display( {
						name => "$i.ui_control_component",
						type => 'select',
						passed => $opt_string,
						override => $c_name,
						default => $c_name,
						help => $help,
						label =>  "Component type",
						filter => 'null_to_comma',
						template => $control_template,
					});
		push @messages, "widget='$widget'";
		# No meta for now
		$widget =~ s/~[A-Z]{3,}~//g;
		push @controls, $widget;

	}

	$template_bot_widget = <<EOF if $CGI->{ui_show_template};
<tr>
<td colspan=2 class=rtitle><img src="${imgpath}admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>
<tr class=ralt>
	<td colspan=2 valign=top>
	<b>Bottom of template</b>
	</td>
</tr>
<tr class=ralt>
	<td colspan=2 class=clabel>
	<TEXTAREA NAME=ui_template_bot COLS=85 ROWS=20>$template_bot_display</TEXTAREA>
	</td>
</tr>
EOF

	$out .= <<EOF;
<tr class=rtitle>
<td colspan=2 class=rtitle>
		<span style="font-size: larger; font-weight: bold">
		Top Region
		</span>
</td>
</tr>
EOF

	for(my $n = 0; $n < $template_break; $n++) {
		$out .= $controls[$n];
	}
	$out .= $template_top_widget if $template_top_widget;
	
	$out .= <<EOF;
<tr class=rtitle>
<td colspan=2 class=rtitle>
		<span style="font-size: larger; font-weight: bold">
		Bottom Region
		</span>
</td>
</tr>
EOF

	for(my $n = $template_break; $n < @controls; $n++) {
		$out .= $controls[$n];
	}
	$out .= $template_bot_widget if $template_bot_widget;
	

	return $out;
	return $out . tmp_error("Finished checking first part.");
[/perl]

<tr>
<td colspan=2 class=rtitle><img src="@_UI_IMG_@admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

<tr class=ralt>
<td colspan=2>
[set Preview]
mv_nextpage=__UI_BASE__/page_preview
mv_action=back
[/set]

[set Save]
mv_nextpage=__UI_BASE__/template_save
[/set]

[set Munge]
[perl]
	$CGI->{good_template} = 1;
	return;
[/perl]
[/set]

<INPUT TYPE=hidden NAME=mv_click VALUE=Munge>
<INPUT TYPE=submit NAME=mv_click VALUE=Preview onClick="this.form.target='page_preview'">
<INPUT TYPE=hidden NAME=ui_return_to VALUE="__UI_BASE__/page">
<INPUT TYPE=submit NAME=mv_click VALUE=Save onClick="this.form.target='_self'">
<INPUT TYPE=submit NAME=mv_click VALUE=Cancel onClick="this.form.target='_self'"><br>

Show template:<BR>
[if cgi ui_show_template]
	<input type=radio name=ui_show_template value="1" CHECKED> Yes&nbsp;&nbsp;&nbsp;
	<input type=radio name=ui_show_template value="0"> No
[else]
	<input type=radio name=ui_show_template value="1"> Yes&nbsp;&nbsp;&nbsp;
	<input type=radio name=ui_show_template value="0" CHECKED> No
[/else]
[/if]

</td>
</tr>

<tr>
<td colspan=2 class=rtitle><img src="@_UI_IMG_@admin/bg.gif" width=__UI_MAIN_WIDTH__ height=1></td>
</tr>

</table>
</form>


<!-- ----- END REAL STUFF ----- -->

@_UI_STD_FOOTER_@
<!-- page: __MV_PAGE__ -->
