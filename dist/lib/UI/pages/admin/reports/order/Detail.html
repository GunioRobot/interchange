[if-mm !advanced orderstats]
	[calc]
			$CGI->{affiliate} = $Session->{username};
			return;
	[/calc]
[/if-mm]
[set page_title]Order detail report[/set]
[set icon_name]admin/icon_stats.gif[/set]
[set help_name]orderstats.view[/set]
@_UI_STD_HEAD_@

[calc]
	if ($comm_field = $Tag->var('UI_COMMISSION_FIELD')) {
		$Scratch->{comm_select} = ", $comm_field";
        $Scratch->{comm_states} = [split (/\s+/, '__UI_COMMISSION_STATES__')];
		if (@{$Scratch->{comm_states}}) {
		    $Scratch->{comm_select} .= ', status';
		}
		$Scratch->{cols} = 8;
	} else {
		$Scratch->{comm_select} = '';
		$Scratch->{cols} = 7;
	}
	return;
[/calc]

<TABLE width="90%" border=0 callpadding=0 cellspacing=0>
<tr bgcolor="#000000" height=1><td colspan=[scratch cols]></td></tr>
<TR BGCOLOR="#__UI_C_TOPBLOCKBAR__">
<TD VALIGN="top">
<FONT COLOR="__UI_C_TITLEBARTXT__">
<B>Order</B>
</FONT>
</TD>
<TD VALIGN="top">
<FONT COLOR="__UI_C_TITLEBARTXT__">
<B>Affiliate</B>
</FONT>
</TD>
<TD VALIGN="top">
<FONT COLOR="__UI_C_TITLEBARTXT__">
<B>Campaign</B>
</FONT>
</TD>
<TD VALIGN="top">
<FONT COLOR="__UI_C_TITLEBARTXT__">
<B>Address</B>
</FONT>
</TD>
<TD VALIGN="top">
<FONT COLOR="__UI_C_TITLEBARTXT__">
<B>Date/Time</B>
</FONT>
</TD>
<TD ALIGN="right" VALIGN="top">
<FONT COLOR="__UI_C_TITLEBARTXT__">
<B>Amount</B>
</FONT>
</TD>
[if scratch comm_select]
<TD ALIGN="right" VALIGN="top">
<FONT COLOR="__UI_C_TITLEBARTXT__">
<B>Commission</B>
</FONT>
</TD>
[/if]
<TD ALIGN="right" VALIGN="top">
<FONT COLOR="__UI_C_TITLEBARTXT__">
<B>Status</B>
</FONT>
</TD>
</TR>
<tr bgcolor="#000000" height=1><td colspan=[scratch cols]></td></tr>
<tr bgcolor="#FFFFFF" height=2><td colspan=[scratch cols]></td></tr>

<!-- will default to current if not set:
		[seti today][tag time]%Y%m[/tag][/seti]
	-->

[calc]
	if($Session->{arg}) {
		$Scratch->{date_limit} = "AND order_date like '$Session->{arg}%'";
	}
	elsif ($CGI->{ui_begin_date}) {
		for (qw/ ui_begin_date ui_end_date /) {
			$CGI->{$_} = $Tag->filter( {
									op => 'date_change',
									body => $CGI->{$_}
								});
		}
		$Scratch->{date_limit} = <<EOF
AND   order_date > '$CGI->{ui_begin_date}'
AND   order_date < '$CGI->{ui_end_date}Z'
EOF
	}
	else {
		$Scratch->{date_limit} = "AND order_date like '$Scratch->{today}%'";
	}
	$Scratch->{synd_limit} = '';
	$Scratch->{campaign_field} = 'campaign';
	$Scratch->{parent_field} = '';
	return unless $CGI->{affiliate};

	if ($parent_field = $Tag->var('UI_AFFILIATE_PARENT_FIELD')) {
	    $Scratch->{synd_limit} = "AND (affiliate = '$CGI->{affiliate}' OR $parent_field = '$CGI->{affiliate}')";
		$Scratch->{campaign_field} = $parent_field;
		$Scratch->{comm_select} .= ', parent_comm';
		$Scratch->{parent_field} = $parent_field;
	} else {
		$Scratch->{synd_limit} = "AND affiliate = '$CGI->{affiliate}'";
	    $Scratch->{synd_limit} .= "AND campaign = '$CGI->{campaign}'"
		    if $CGI->{campaign};
	}

	return;
[/calc]

[query	hashref=main
	st=db
	table=transactions
	sql="
	select order_number, affiliate, [scratch campaign_field], total_cost, payment_method, state, city, status, order_date[scratch comm_select]
		from  transactions
		WHERE deleted != '1'
		[scratch date_limit] [scratch synd_limit]
		order by order_number
	"][/query]

[perl tables="store"]
	return <<EOF unless $Tmp->{main};
	<TR BGCOLOR="__UI_C_INTBLOCK__">
	<TD VALIGN=top>
	<H2>Bad query specified, caused error.</H2>
	</TD>
EOF
	foreach $line (@{$Tmp->{main}}) {
		$total_sales    += $line->{total_cost};
		$amount = sprintf '%.2f', $line->{total_cost};
		$url = $Tag->area('__UI_BASE__/order_view', $line->{order_number});
		if ($Scratch->{comm_select}) {
			if (! @{$Scratch->{comm_states}} 
				|| grep {$_ eq $line->{status}} @{$Scratch->{comm_states}}) {
				if ($Scratch->{parent_field} 
					&& $line->{$Scratch->{parent_field}} eq $CGI->{affiliate}) {
					$commission = $line->{parent_comm};
				} else {
					$commission = sprintf '%.2f', $line->{commission};
				}
			} else {
				$commission = '0.00';
			}
			$commcell = "<TD ALIGN=right VALIGN=top>\n" 
				. $Tag->currency({}, $commission) . "\n</TD>\n";
		} else {
			$commcell = '';
		}
		$out .= <<EOF;
	<TR BGCOLOR="__UI_C_INTBLOCK__">
	<TD VALIGN=top>
	<A HREF="$url">$line->{order_number}</A>
	</TD>
	<TD VALIGN=top>
	$line->{affiliate}&nbsp;
	</TD>
	<TD VALIGN=top>
	$line->{$Scratch->{campaign_field}}&nbsp;
	</TD>
	<TD VALIGN=top>
	$line->{city}, $line->{state}
	</TD>
	<TD VALIGN=top>
	$line->{order_date}
	</TD>
	<TD ALIGN=right VALIGN=top>
	$amount
	</TD>
	$commcell
	<TD ALIGN="right" VALIGN=top>
	$line->{status}
	</TD>
	</TR>
EOF
	}
		$total_sales  = sprintf '$%.2f', $total_sales;
		$out .= <<EOF;
<tr bgcolor="#FFFFFF" height=2><td colspan=[scratch cols]></td></tr>
<tr bgcolor="#000000" height=1><td colspan=[scratch cols]></td></tr>
	<TR BGCOLOR="__UI_C_INTBLOCK__">
	<TD VALIGN="top">
	GRAND TOTAL
	</TD>
	<TD VALIGN="top">
	&nbsp;
	</TD>
	<TD VALIGN="top">
	&nbsp;
	</TD>
	<TD ALIGN="right" VALIGN="top">
	&nbsp;
	</TD>
	<TD ALIGN="right" VALIGN="top">
	&nbsp;
	</TD>
	<TD ALIGN="right" VALIGN="top">
	$total_sales
	</TD>
	<TD ALIGN="right" VALIGN="top">
	&nbsp;
	</FONT>
	</TD>
	</TR>
	<tr bgcolor="#000000" height=1><td colspan=7></td></tr>

EOF
[/perl]
</TABLE>

@_UI_STD_FOOTER_@
