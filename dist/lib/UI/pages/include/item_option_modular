<!-- ----- BEGIN REAL STUFF ----- -->
[if scratch ui_failure]
<P>
<BLOCKQUOTE>
<FONT COLOR="__CONTRAST__">[scratch ui_failure][set ui_failure][/set]</FONT>
</BLOCKQUOTE>
<P>
&nbsp;
[/if]
[if scratch ui_message]
<P>
<BLOCKQUOTE>
<FONT COLOR="__CONTRAST__">[scratch ui_message][set ui_message][/set]</FONT>
</BLOCKQUOTE>
<P>
&nbsp;
[/if]
[page href="@@MV_PAGE@@"
		form="
			explode=1
			sku=[cgi item_id]
	"]Explode all</A>&nbsp;&nbsp;&nbsp;[page href="@@MV_PAGE@@"
		form="
			collapse=1
			sku=[cgi item_id]
	"]Collapse all</A>
<TABLE CELLSPACING=0 CELLPADDING=2 CELLMARGIN=3 WIDTH="100%">
<TR BGCOLOR="__UI_C_TITLEBARBG__">
	<TH ALIGN=LEFT><FONT COLOR="__UI_C_TITLEBARTXT__">SKU</TH>
	<TH ALIGN=LEFT><FONT COLOR="__UI_C_TITLEBARTXT__">Master</TH>
	<TH ALIGN=LEFT><FONT COLOR="__UI_C_TITLEBARTXT__">Description</TH>
	<TH ALIGN=RIGHT><FONT COLOR="__UI_C_TITLEBARTXT__">Price</TH>
</TR>
[seti mod_template]
<TR>
<TD>&nbsp;{ui_spacer}{ui_action?}[page href="@@MV_PAGE@@"
							form="
								mv_data_table=[cgi mv_data_table]
								sku=[cgi item_id]
								UI_ACTION=
							"]{/ui_action?}{ui_action_img}{ui_action </A>}&nbsp;[page
				href=__UI_BASE__/flex_editor
				form=|
					mv_data_table=[cgi mv_data_table]
					ui_page_title=[cgi ui_page_title]
					ui_page_banner=[cgi ui_page_banner]
					ui_class=Items
					ui_meta_view=modular
					ui_hide_key=1
					ui_te_override:description={url.description}
					ui_display_only=products:description
					ui_data_fields=code sku o_master o_enable products:description
					ui_meta_specific=[cgi ui_meta_specific]
					ui_return_to=@@MV_PAGE@@
					ui_return_to=ui_return_table=[cgi mv_data_table]
					ui_return_to=sku=[cgi item_id]
					item_id={code}
				|]{sku}</A></TD>
<TD>{o_master}</td>
<TD>{products.description}</td>
<TD ALIGN=RIGHT>{products.price}</td>
</tr>
[/seti]
[comment]
[set mod_template]master={o_master}|sku={sku}|action={ui_action}|leval={level}|enable={o_enable}|{q}
[/set]
[/comment]
[perl tables="products [cgi mv_data_table]"]
	for(qw/ ui_mod_expand ui_mod_explode /) {
		$Session->{$_} = {} 
			if ! $Session->{$_};
	}
	if($CGI->{expand}) {
		$Session->{ui_mod_expand}{$CGI->{item_id}}{$CGI->{expand}} = 1;
	}
	elsif($CGI->{contract}) {
		$Session->{ui_mod_expand}{$CGI->{item_id}}{$CGI->{contract}} = 0;
	}
	elsif($CGI->{collapse}) {
		delete $Session->{ui_mod_explode}{$CGI->{item_id}};
		delete $Session->{ui_mod_expand}{$CGI->{item_id}};
	}
	elsif($CGI->{explode}) {
		delete $Session->{ui_mod_expand}{$CGI->{item_id}};
		$Session->{ui_mod_explode}{$CGI->{item_id}} = 1;
	}
	$Session->{ui_mod_expand}{$CGI->{item_id}} = {}
		unless $Session->{ui_mod_expand}{$CGI->{item_id}};
	$expand = $Session->{ui_mod_expand}{$CGI->{item_id}};
	$explode = $Session->{ui_mod_explode}{$CGI->{item_id}};
	$otab = $CGI->{mv_data_table};
	$ptab = '__ProductFiles_0__';
	$Scratch->{mod_template} =~ s/\%7b/{/g;
	$Scratch->{mod_template} =~ s/\%7d/}/g;
	$Scratch->{mod_template} =~ s/UI_ACTION=/{ui_action}/g;
	$odb = $Db{$otab}
		or return "bad options database";
	$pdb = $Db{$ptab}
		or return "bad products database";
	my $price_fld = $pdb->column_exists('__PriceField__')
						? '__PriceField__'
						: 'price';
	delete $Scratch->{debug_body};
	sub display_template {
		my ($ref) = @_;
		my $sku = $ref->{sku};
		my $code = $ref->{code};
		$ref->{"products.description"} = tag_data($ptab, '__DescriptionField__', $sku);
		$ref->{"url.description"} = $Tag->filter('urlencode', $ref->{"products.description"});
		$ref->{"products.price"} =  tag_data($ptab, $price_fld, $sku);

#### Just used to set up some levels in test data
#		my %dict = qw/
#						0 First
#						1 Second
#						2 Third
#						3 Fourth
#						4 Fifth
#						5 Sixth
#						/;
#		$dict{''} = 'First';
#		$dict = $dict{$ref->{level}};
#		if ($dict
#			and $ref->{"products.description"}
#			)
#		{
#			my $cat = tag_data('products', 'category', $sku);
#			$ref->{"products.description"} =~ s/^option\s+/$cat /i;
#			$pdb->set_field($sku, 'description', $ref->{"products.description"});
#		}
#
		if($ref->{level}) {
			my $level = $ref->{level} * 28;
			$ref->{ui_spacer} = qq{<IMG SRC="@_UI_IMG_@admin/bg.gif" HEIGHT=1 WIDTH=$level>};
		}
		my $indent = $ref->{level} + 1;
		if($ref->{o_enable}) {
			if($expand->{$code} or $explode && ! defined $expand->{$code}) {
				$ref->{ui_action} = "contract=$code";
				$ref->{ui_action_img} = 
					 qq{<FONT size=1>$indent</FONT><IMG SRC="@_UI_IMG_@admin/down.gif" height=11 width=14 BORDER=0>};
			}
			else {
				$ref->{ui_action} = "expand=$code";
				$ref->{ui_action_img} = 
					 qq{<FONT size=1>$indent</FONT><IMG SRC="@_UI_IMG_@admin/right.gif" height=11 width=14 BORDER=0>};
			}
		}
		else {
			$ref->{ui_action_img} = 
				 qq{<IMG SRC="@_UI_IMG_@admin/bg.gif" HEIGHT=1 WIDTH=14>};
		}
		my $body = $Scratch->{mod_template};
Log("body first:\n$body\n\n") unless $Scratch->{debug_body};
		$body =~ s!(\{\w+)\%2e(\w+\})!$1.$2!g;
		$body =~ s!\{([-\w.]+)\}!$ref->{$1}!g;
		$body =~ s!\{([-\w.]+)\|([\000-\377]*?)\}!$ref->{$1} || $2!eg;
		$body =~ s!\{([-\w.]+)\s+([\000-\377]*?)\}! $ref->{$1} ? $2 : ''!eg;
		$body =~ s!\{([-\w.]+)\?\}([\000-\377]*?){/\1\?\}! $ref->{$1} ? $2 : ''!eg;
		$body =~ s!\{([-\w.]+):\}([\000-\377]*?){/\1:\}! $ref->{$1} ? '' : $2!eg;
Log("body now:\n$body\n\n") unless $Scratch->{debug_body}++;
		return $body;
	}
	return;
[/perl]
[query
	list=1
	hashref=master
	sql="SELECT * FROM options
			WHERE o_master = '[cgi name=item_id filter=sql]'
			ORDER BY o_sort
		"]
[sql-sub o_display]
	my $master = shift;
	my $row = shift;
	my @rows;
Log("received master=$master row=$row modular=$row->{o_enable}");
	my @stack = ( [ $row ] );
	ARY: for (;;) {
		my $ary;
		$ary = pop(@stack)
			or last ARY;
		ROW: for(;;) {
			$row = shift @$ary
				or last ROW;
			$row->{level} = scalar(@stack);
			push(@rows, $row);
			next ROW if ! $row->{o_enable};
			my $sku = $row->{sku};
			my $code = $row->{code};
			if( $expand->{$code}
					or 
				($explode and ! defined $expand->{$code})
				)
			{
				push(@stack, $ary);
				my $key = $odb->quote($sku, 'sku');
				my $q = "SELECT * FROM options WHERE o_master = $key ORDER BY o_sort",
				$ary = $odb->query(
						{ 
							hashref => 1,
							sql => "SELECT * FROM options
									WHERE o_master = $key
									ORDER BY o_sort
								",
						}
				);
			}
		}  # END ROW
	}  # END ARY
	
	my $out;
	for(@rows) {
		$out .= display_template($_);
	}
	return $out;
[/sql-sub]
[sql-exec o_display][sql-code][/sql-exec]
[/query]
</table>

[page href=__UI_BASE__/flex_editor
		form="
			mv_data_table=[cgi mv_data_table]
			ui_class=Items
			ui_data_fields=code sku o_master o_enable
			ui_preload:options:o_enable=1
			ui_meta_view=modular
			ui_hide_key=1
			ui_new_item=1
			ui_page_banner=[cgi ui_page_banner]
			ui_page_title=[cgi ui_page_title]
			ui_return_to=@@MV_PAGE@@
			ui_return_to=ui_return_table=[cgi mv_data_table]
			ui_return_to=sku=[cgi item_id]
		"]<IMG SRC="@_UI_IMG_@admin/plus.gif" ALT="Add new option" BORDER=0></A>
&nbsp;&nbsp;

