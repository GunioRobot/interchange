# This is a new option that ignores C-style directives like #ifdef,
# #endif, #include, and only parses plain ifdef, endif, include, etc.
# It can be turned on and off repeatedly as needed. When it's off,
# you can now be confident that a line starting with a # is a comment.
# This affects the entire configuration of this catalog, but not any
# other catalogs running under the same daemon. Check your old files
# if you're upgrading.
ConfigParseComments No

# Set the sitewide information. The initial settings
# in the "variable" table are shown below; subsequent
# changes are only in the database, not below.

VariableDatabase variable

### These reflect the initial settings set above;
### if you uncomment them they will override it.
#
#Variable    SERVER_NAME     __MVC_SERVERNAME__
#Variable    CGI_URL         __MVC_CGIURL__
#Variable    SECURE_SERVER   http://__MVC_SERVERNAME__
#Variable    ORDERS_TO       __MVC_MAILORDERTO__
#Variable    IMAGE_DIR       __MVC_IMAGEURL__
#Variable    DOCROOT         __MVC_DOCUMENTROOT__
#Variable    SAMPLEHTML      __MVC_SAMPLEHTML__
#Variable    SAMPLEURL       __MVC_SAMPLEURL__
#
#Variable    COMPANY         __MVC_COMPANY__
#Variable    ENCRYPTOR       __MVC_ENCRYPTOR__
#
#Variable    SOMESQL         __MVC_MYSQL____MVC_PGSQL____MVC_ORACLE__
#Variable    MYSQL           __MVC_MYSQL__
#Variable    PGSQL           __MVC_PGSQL__
#Variable    ORACLE          __MVC_ORACLE__
#Variable    SQLDSN          __MVC_SQLDSN__
#Variable    SQLDB           __MVC_SQLDB__
#Variable    SQLUSER         __MVC_SQLUSER__
#Variable    SQLPASS         __MVC_SQLPASS__

# Here you can set up fatal or non-fatal errors if a necessary sub or usertag
# doesn't exist, uncomment one of next lines to test
#
#Require globalsub nevairbe
#Require usertag   nevairbe
#Require module    Perl::NevairBe
#Suggest module    Perl::NevairBe "Need %s %s to test the Suggest directive."

Suggest module Digest::MD5    "Need %s %s for better cache keys."
Suggest module Safe::Hole

Require UserTag   email email_raw var loc table_editor button

ifdef SOMESQL
Require module DBI
Suggest module SQL::Statement "Need %s %s for proper search form parsing."
endif

ifndef SOMESQL
Suggest module SQL::Statement
endif

ifdef MYSQL
Require module DBD::mysql
endif

ifdef PGSQL
Require module DBD::Pg
endif

ifdef ORACLE
Require module DBD::Oracle
endif


## END SITE CONFIGURATION

ParseVariables  Yes

#########
######### Set the catalog URLS, using the Variable settings above.
#########
##
## The URLs which are written to call the CGI link script.
## 
VendURL                 http://__SERVER_NAME____CGI_URL__
SecureURL               __SECURE_SERVER____CGI_URL__

## Set the image path for relative images
ImageDir                __IMAGE_DIR__/
ImageDirInternal        http://__SERVER_NAME____IMAGE_DIR__/

##
#########
######### 
#########

#########
######### Some user session related settings...
#########
#
#

## Whether to encrypt passwords in UserDB
## We usually don't for users, so we can mail them their password
## We DO in admin, that is set in catalog_after.cfg
UserDB    default    crypt         0

## Change a field to something that doesn't conflict in MySQL
UserDB    default    time_field    mod_time

## Don't want people setting their credit limit or dealer status directly
UserDB    default    scratch       "dealer credit_limit price_level"

### minimal login stuff for affiliate
UserDB    affiliate  user_field    affiliate
UserDB    affiliate  database      affiliate
UserDB    affiliate  time_field    none
UserDB    affiliate  crypt         0

## Set some initial values
ScratchDefault   mv_add_dot_html   1
ScratchDefault   mv_no_session_id  1
ScratchDefault   mv_no_count       1
ScratchDefault   order_style       1
ValuesDefault    mv_shipmode       upsg
ValuesDefault    show_basket       1
#
#
#########
#########
#########

################################################################
########   These define the variables for templating    ########
########   You see them in pages with __LEFTRIGHT_TOP__ ########
########                                                ########
########   Files are actually in templates/regions dir  ########
########                                                ########
################################################################

## Define some colors
##
Variable   HEADERBG    BGCOLOR="#669999"
Variable   HEADERTEXT  #FFFFFF
Variable   TITLEBG     BGCOLOR="#669999"
Variable   TITLETEXT   #FFFFFF

## Put in memory with high traffic settings
## Better performance this way
## TRAFFIC is defined in interchange.cfg
##
## Variables used in these files must have been previously defined

ifdef @TRAFFIC =~ /high/i
ParseVariables  Yes
ConfigDir templates/regions
Variable      NOLEFT_TOP       <NOLEFT_TOP
Variable      NOLEFT_BOTTOM    <NOLEFT_BOTTOM
Variable      LEFTRIGHT_TOP    <LEFTRIGHT_TOP
Variable      LEFTRIGHT_BOTTOM <LEFTRIGHT_BOTTOM
Variable      LEFTONLY_TOP     <LEFTONLY_TOP
Variable      LEFTONLY_BOTTOM  <LEFTONLY_BOTTOM
Variable      SEL_LEFT_TOP     <SEL_LEFT_TOP
Variable      SEL_LEFT_BOTTOM  <SEL_LEFT_BOTTOM
Variable      SEL_ALL_TOP      <SEL_ALL_TOP
Variable      SEL_ALL_BOTTOM   <SEL_ALL_BOTTOM
ConfigDir config
endif

## Use [include ...] with low traffic settings, file read every time
## template changes show up immediately this way
## TRAFFIC is defined in interchange.cfg
##

ifdef @TRAFFIC =~ /low/i
Variable      NOLEFT_TOP       [include templates/regions/NOLEFT_TOP]
Variable      NOLEFT_BOTTOM    [include templates/regions/NOLEFT_BOTTOM]
Variable      LEFTRIGHT_TOP    [include templates/regions/LEFTRIGHT_TOP]
Variable      LEFTRIGHT_BOTTOM [include templates/regions/LEFTRIGHT_BOTTOM]
Variable      LEFTONLY_TOP     [include templates/regions/LEFTONLY_TOP]
Variable      LEFTONLY_BOTTOM  [include templates/regions/LEFTONLY_BOTTOM]
Variable      SEL_LEFT_TOP     [include templates/regions/SEL_LEFT_TOP]
Variable      SEL_LEFT_BOTTOM  [include templates/regions/SEL_LEFT_BOTTOM]
Variable      SEL_ALL_TOP      [include templates/regions/SEL_ALL_TOP]
Variable      SEL_ALL_BOTTOM   [include templates/regions/SEL_ALL_BOTTOM]
endif

#
################################################################
################################################################

ParseVariables  Yes

# Sets Interchange to not parse <BODY MV="body 1"> and other tags within
# HTML tags, use [pragma no_html_parse 0] to enable on a page
Pragma          no_html_parse

MailOrderTo             __ORDERS_TO__


################################################################
########   DATABASE SETUP                               ########
########                                                ########
########   When you defined your catalog, you specified ########
########   a database type. This region uses include    ########
########   to include the database definitions based    ########
########   on that choice.                              ########
########                                                ########
########   See the directories in dbconf/ for the       ########
########   different types.                             ########
########                                                ########
################################################################
##
##

ifndef SQLDSN
Variable    SQLDSN          dbi:mysql:test_construct
endif

#####
##### MySQL
#####
ifdef MYSQL

Message Using MySQL, DSN=__SQLDSN__.

# Tell the default DBM we are using something else...
Variable  SOME_DATABASE  1

# Uncomment if needed
#Variable  SQLUSER  foo
#Variable  SQLPASS  bar

# The table defs are in separate files in the dbconf/mysql directory,
# the ones kept in DBM are in TABLENAME.dbm files.

include dbconf/mysql/*

endif

#####
##### PostgreSQL
#####
ifdef PGSQL

Message Using PostgreSQL, DSN=__SQLDSN__.

# Tell the default DBM we are using something else...
Variable  SOME_DATABASE  1

# Uncomment and edit if needed
#Variable  SQLUSER  foo
#Variable  SQLPASS  bar

# The table defs are in separate files in the dbconf/pgsql directory,
# the ones kept in DBM are in TABLENAME.dbm files.

include dbconf/pgsql/*

endif

#####
##### Oracle
#####
ifdef ORACLE

Message Using Oracle, DSN=__SQLDSN__.

# Tell the default DBM we are using something else...
Variable  SOME_DATABASE  1

# Oracle considers 'session', 'size', and 'comment' to be reserved
# words. Since we use those as column names, attach this arbitrary
# string to the end of each word to make it acceptable to Oracle.
# Note that this must be defined before the include below.
Variable  FIELDMUNGE  

# Uncomment and edit if needed
#Variable  SQLUSER  foo
#Variable  SQLPASS  bar

# The table defs are in separate files in the dbconf/oracle directory,
# the ones kept in DBM are in TABLENAME.dbm files.

include dbconf/oracle/*

endif

#####
##### Default DBM if nothing else defined
#####
ifndef SOME_DATABASE

# The table defs are in separate files in the dbconf/dbm directory.

Message Using default DBM database.
include dbconf/default_db/*

endif

Database arbitrary arbitrary.txt TAB
Database arbitrary dir /cc/oproducts

ProductFiles   products options

##
##
################################################################
########                end database setup               #######
################################################################

AlwaysSecure         ord/checkout multi/checkout
AsciiTrack           logs/tracking.asc

################################################################
########                   Pricing setup                 #######
################################################################
########                                                 #######
########  In the construct demo, if the user is logged   #######
########  in and is marked as a "dealer" (1 in the       #######
########  dealer field in the userdb database) then      #######
########  they are given quantity discounts based on     #######
########  price groups. (All products except gift_cert   #######
########  are in price group 1 as distributed.) If       #######
########  the quantity is 1, then pricing comes from     #######
########  the "wholesale" field in the products          #######
########  database.                                      #######
########                                                 #######
########  If the user is not a dealer (or not logged in) #######
########  then pricing just comes from "price". There    #######
########  are no quantity discounts unless you are a     #######
########  dealer; all items are taxable.                 #######
########                                                 #######
########  The "gift_cert" AutoModifier allows special    #######
########  receipt, basket, and checkout display handling #######
########  for items defined as a gift_cert.              #######
########                                                 #######

PriceField     no_price

Profile dealer <<EOR
{ 
	CommonAdjust => <<EOF,

		pricing:w5,w10:,
		;:wholesale,
		;:wholesale:mv_sku,
		;$,
		==:options
EOF
	NonTaxableField => 'nontaxable',
}
EOR

Profile default CommonAdjust   ";:price, ;:price:mv_sku, ;$, ==:options"
Profile default NonTaxableField 

AutoModifier   pricing:price_group
AutoModifier   products:gift_cert

########                                                 #######
################################################################

## Set this to No if you don't want auto-login capability for users
CookieLogin  Yes

# These are usually all you need for CyberCash 3
# Uncomment and edit to suit; make sure you remove CreditCardAuto somehow
#
#Variable         CYBER_CONFIGFILE    /home/you/yourid75/mck-cgi/merchant_conf
#Variable         CYBER_VERSION       3.2
#Variable         MV_PAYMENT_MODE     mauthonly

EncryptProgram   __ENCRYPTOR__

# Uncomment only if you have these locales on your system
#Locale          de_DE
#Locale          de_DE LC_CTYPE de_DE
#Locale          fr_FR
#Locale          en_US

Locale          en_US LC_CTYPE C
LocaleDatabase  locale

Onfly           onfly
OrderCounter    etc/order.number
OrderLineLimit  25
OrderProfile    etc/profiles.order etc/profiles.login etc/profiles.misc
SearchProfile   etc/profiles.search

# Allow others in our group to read/write files by default
ReadPermission  group
WritePermission group
RobotLimit      50

# Here we override Interchange's normal order routine
ActionMap  order   <<EOR
sub {
	#Log('in order action');
	if($CGI->{mv_nextpage} ne 'order') {
		# Do nothing
	}
	elsif($Values->{no_basket}) {
		$CGI->{mv_nextpage} = 'ord/nobasket';
	}
	else {
		$CGI->{mv_nextpage} = 'ord/basket';
	}
	$CGI->{mv_order_item} = $CGI->{mv_arg}
		if ! $CGI->{mv_order_item};
	$Tag->update('values');
	return 1;
}
EOR

ActionMap  deliver   <<EOR
sub {
	my $deliverable = shift;
	$Scratch->{deliverable} = $CGI->{mv_arg};
	$CGI->{mv_nextpage} = 'deliver';
	return 1;
}
EOR

ActionMap  get_password   <<EOR
sub {
	$Config->{NoSearch} = '';
	$CGI->{mv_nextpage} = $CGI->{mv_search_page} = 'action/get_password';
	$CGI->{mv_todo} = 'search';
	$Tag->update('process');
	return 1;
}
EOR

ParseVariables Yes
Route log         attach          0
Route log         cybermode       ""
Route log         empty           1
Route log         encrypt         0
Route log         increment       0
Route log         report          etc/log_transaction
Route log         supplant        0
Route log         track           logs/log

Route log_entry   attach          0
Route log_entry   cybermode       ""
Route log_entry   empty           1
Route log_entry   encrypt         0
Route log_entry   increment       0
Route log_entry   report          etc/log_entry
Route log_entry   supplant        0
Route log_entry   track           logs/log

Route copy_user   attach          0
Route copy_user   cybermode       ""
Route copy_user   empty           1
Route copy_user   encrypt         0
Route copy_user   increment       0
Route copy_user   report          etc/mail_receipt
Route copy_user   supplant        0
Route copy_user   track           logs/log

# Main route must be last to make default
Route main        attach           0
Route main        credit_card      0
Route main        cybermode        ""
Route main        default          1
Route main        email            '__ORDERS_TO__'
Route main        encrypt          0
Route main        encrypt_program  '__ENCRYPTOR__'
Route main        errors_to        '__ORDERS_TO__'
Route main        increment        0
Route main        pgp_cc_key       ""
Route main        pgp_key          ""
Route main        receipt          etc/receipt.html
Route main        report           etc/report
Route main        supplant         1
Route main        individual_track orders
Route main        track            logs/tracking.asc

# Order routes can be maintained in a database, empty in demo
# CHANGES TO THIS WILL OVERRIDE THE ROUTES ABOVE
RouteDatabase    route

SalesTax         __TAXFIELD__
TaxShipping      __TAXSHIPPING__
FractionalItems  Yes
SeparateItems    Yes

SpecialPage          catalog        index
SpecialPage          report         ../etc/report
SpecialPage          receipt        ../etc/receipt

NoCache              admin config multi ord query reconfig special

Static        __CATALOG_STATIC__
StaticLogged  __LOGGED_STATIC__
StaticAll     Yes
StaticDBM     static
StaticDepth   2
StaticDir     __SAMPLEHTML__/pages
StaticFly     Yes
StaticPath    __SAMPLEURL__/pages

ifdef UI_TRAFFIC_STATS
TrackFile __UI_TRAFFIC_STATS__
endif

UpsZoneFile   products/450.csv

History 10
UserTag history-scan Order find exclude default
UserTag history-scan addAttr
UserTag history-scan Routine <<EOR
my %var_exclude = ( qw/
	mv_credit_card_number 1
	mv_pc                 1
	mv_session_id         1
/);
sub {
	my ($find, $exclude, $default) = @_;
	my $ref = $Vend::Session->{History}
		or return $Tag->area($default || $Config->{SpecialPage}{catalog});
	my ($hist, $href, $cgi);
	$exclude = qr/$exclude/ if $exclude;
	for(my $i = $#$ref; $i >= 0; $i--) {
		#Log("checking $ref->[$i][0] for $exclude");
		if ($exclude and $ref->[$i][0] =~ $exclude) {
			next;
		}
		if($find) {
			next unless $ref->[$i][0] =~ /$find/;
		}
		($href, $cgi) = @{$ref->[$i]};
		last;
	}
	return $Tag->area($default || $Config->{SpecialPage}{catalog})
		if ! $href;
	my $form = '';
	for(grep !$var_exclude{$_}, keys %$cgi) {
		$form .= "\n$_=";
		$form .= join("\n$_=", split /\0/, $cgi->{$_});
	}
	return $Tag->area( { href => $href, form => $form} );
}
EOR
