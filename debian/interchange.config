#! /bin/sh -e

# Source debconf library
. /usr/share/debconf/confmodule

if [ -e /etc/interchange/init.cfg ]; then
	# Read current state from configuration file
	. /etc/interchange/init.cfg || true
	if [ "$MODE" = "--unix" ]; then
		db_set interchange/mode "unix mode"
	elif [ "$MODE" = "--inetmode" ]; then
		db_set interchange/mode "internet mode"
	else 
		db_set interchange/mode "both"
	fi
	db_set interchange/group $GROUP
	db_set interchange/user $USER
fi

# Which mode we should use ?
db_input medium interchange/mode || true
db_go

# Remember old interchange user/group configuration

db_get interchange/user || true
OLDUSER=$RET
db_set interchange/olduser $OLDUSER

# Which user should be choosed for the interchange server ?

HAVEUSER=0
while [ $HAVEUSER -eq 0 ]; do
	db_input medium interchange/user || true
	db_go
	db_get interchange/user
	USER=$RET

	if [ -z "$USER" ]; then
		USER=interchange
	fi

	if [ "$USER" = root ]; then
		db_input medium interchange/usernoroot || true
		db_go
	elif grep -q ^$USER: /etc/passwd; then
		HAVEUSER=1
	else
		db_subst interchange/createuser USER $USER
		db_input medium interchange/createuser || true
		db_go
		db_get interchange/createuser || true
		CREATEUSER=$RET
		if [ "$CREATEUSER" = true ]; then
			HAVEUSER=1
		fi
	fi

	if [ $HAVEUSER -eq 0 ]; then
		db_fset interchange/user isdefault true
		db_reset interchange/user
		db_fset interchange/createuser isdefault true
		db_reset interchange/createuser
	fi
done

# Which group should be choosed for the interchange server ?

HAVEGROUP=0
while [ $HAVEGROUP -eq 0 ]; do
	db_input medium interchange/group || true
	db_go
	db_get interchange/group
	GROUP=$RET

	if [ -z "$GROUP" ]; then
		GROUP=interchange
	fi

	if [ "$GROUP" = root ]; then
		db_input medium interchange/groupnoroot || true
		db_go
	elif grep -q ^$GROUP: /etc/group; then
		HAVEGROUP=1
	else
		db_subst interchange/creategroup GROUP $GROUP
		db_input medium interchange/creategroup || true
		db_go
		db_get interchange/creategroup || true
		CREATEGROUP=$RET
		if [ "$CREATEGROUP" = true ]; then
			HAVEGROUP=1
		fi
	fi

	if [ $HAVEGROUP -eq 0 ]; then
		# no appropriate group, reset and try again
		db_fset interchange/group isdefault true
		db_reset interchange/group
		db_fset interchange/creategroup isdefault true
		db_reset interchange/creategroup
	fi
done
