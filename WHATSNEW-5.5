------------------------------------------------------------------------------

                  What's new in each version of Interchange
                       (since the version 5.4 branch)

------------------------------------------------------------------------------

See UPGRADE document for incompatible changes not listed here.

Interchange 5.5.2 (unreleased).

Core
----

* Allow box-based widgets access to VALUE from option template (in addition
  to LABEL). With VALUE added, the following template becomes possible:

	option_template => "<img src='/images/{VALUE}.gif'>&nbsp;{LABEL}"

* Fixed the MinQuantityField and MaxQuantityField enforcement code so that
  it takes the entire cart into account when SeparateItems is in use.

* New SocketReadTimeout global configuration parameter that controls
  the amount of time (in seconds) that Interchange will wait for incoming
  request data to arrive on an open socket.  This was previously hard-coded
  to one second, but that value was found to be too slow for some dial-up
  Internet users.

* Fix to the "random" parameter used by looping tags.

	-- If set to "no" or "false" or "0" then return all of the results
	   their original order (previously returned one random result).

	-- If set to "yes" or "true" then then return all results in a
	   random order (again, previously returned one random result).
	   
	-- If set to a numeric > 0 then return that many random results.

	-- If set to a numeric > the available results then return all
	   results in a random order (previously returned the original
	   results in the original order).
	
  If you're using "random=yes" to request one random result then you
  will need to change your code to use random=1 instead.

* Altered the DomainTail directive to take subdomains of various ccTLDs
  into account.  For example, if "foo.example.co.uk" pays a visit then
  "example.co.uk" as the domain tail will be used instead of just "co.uk".

  This is done with a new CountrySubdomains directive.  A predefined block
  of country subdomains is listed in a new subdomains.cfg file, which
  should be "included" into the interchange.cfg file.

* Modified MaxQuantityField to support more than one quantity "[table:]column"
  specification.  The column values get added together to create the maximum
  quantity value.

  The idea is that you might have an "on hand" quantity and an "on order"
  quantity that you want to consider when allowing orders.

* Created a new [PREFIX-include] loop sub-tag.  This works just like the
  [include] tag, except that it allows other [PREFIX-*] sub-tags to be
  parsed from within the included file.
  
  Note: Files included with [PREFIX-include] cannot contain further
  [PREFIX-include] sub-tags.  This could be easily created (respecting
  the "include_depth" Limit etc.) but I felt that that was an unnecessary
  overhead.

* Allow for the proper display of product options that use text or textarea
  widgets by showing the actual value if a label doesn't exist for the value.

* You can now change the default display type for Matrix widgets (ie if you
  want the default to be seperate widgets instead of single widget) with a line
  in catalog.cfg like this:
	Options Matrix display_type separate

* New Multiple CodeDef flag to indicate that a widget can return multiple
  selections.  Usage example:
	CodeDef checkbox Multiple 1

* Set new Multiple flag for checkbox, movecombo, check_nbsp and multiple
  widgets.

* Log missing order reports.

* Unlinking the existing session file before re-writing it causes a race
  condition in the FETCH method, where if it checks with a concurrent request
  on the same session while the file is missing, the failure causes Interchange
  to create a new session for the user. As long as the file exists continuously,
  the lock kicks in and concurrent requests serialize appropriately.

* New universal "hide" attribute.  You can now set the attribute hide=1 for any
  tag to suppress its output.  For example [calcn hide=1]$foo='bar'[/calcn] will
  still set $foo to bar, but won't output bar from the tag itself.

* Recognize "cc" and "bcc" headers in Route settings for emails generated 
  directly by the routes.

* Avoid multiple identical cookies (#150).

* Job server displays catalog and job name in $0.

* Renamed catalog_init SpecialSub to request_init to accommodate for a hook
  called after catalog configuration (#160).

UserTag
-------

* Added scratch option to [get-url] for saving binary content into a scratch
  variable instead of returning it.

Payment
-------

* Removed inoperative WellsFargo payment module.

Jobs
----

* Force email notification of errors, can be prevented with ignore_errors
  setting.

Standard demo
-------------

* Fixed a security bug where an attacker could craft a URI that tricks
  Interchange into executing arbitrary Perl code.  The Perl code would be 
  subject to the Safe constraints of course, but could still be devastating 
  to the security of the target website.

* Display modified date on Saved Carts / Recurring Order page in a human
  readable format (#37).

UI
--

* Matrix options editor can now display more than 50 variants via the use of a
  more-list.

* Fix sort order of generated variant codes so that they match the code that is
  ordered from the flypage.

* You can now mark individual options to be treated as "simple options" even
  though the product is set to Matrix options.  This is useful if you have one
  or more options that you don't wish to track for inventory purposes or if you
  want to use a text or textarea widget (which is not possible with matrix
  options).  Requires the addition of an o_simple column to the options table
  for existing catalogs.

* New [widget-info] UI tag.

* Option editor will now correctly generate variants for options that use
  widgets capable of multiple selections (ie, multiple or checkbox widgets).

Packaging
---------

* Apache 2 is now default webserver for Debian packages.

* Added missing dbconfig-common hooks and set defaults for database name and
  database user to interchange-cat-standard Debian package.

Interchange 5.5.1 released on 2007-08-21.

Core
----

* Removed odd formatting from --add entry in interchange manual page.

* Fixed a DoS exploit. A carefully crafted HTTP POST request could cause
  an Interchange page processor to hang until it's killed by Interchange's
  periodic housekeeping routine. If several of these requests are received
  in quick succession then it could be possible to disable all of the page
  processors, rendering Interchange unresponsive for a while. Fixed by
  Kevin Walsh; pointed out by Donald Alexander.

* Removed unused AdminHost global configuration directive.

* In &Vend::Table::DBI::set_row, avoid unwanted expansion of array when we
  have PREFER_NULL fields and number of fields passed is one.

* Added Vend::Swish2 module provided by Brian Miller <brian@endpoint.com>.
  This is superior to Vend::Swish, because instead of the awkward way to
  interface with Swish-e by running the binary it uses the Swish Perl API.

  Note: This module will replace Vend::Swish after we ensure as much backward
  compatibility as possible.

* Allow specification of one additional include directory for specific
  modules, specified like this:

  Require module Vend::Swish /usr/lib/swish-e/perl

* Terminate search if mv_min_string condition isn't met.

* Make [sql-quote] list tag to work properly with multiple lines.

* Fixed case-insensitive searches for different locales.

* Fix the [error] tag so it does not attempt to replace format specifiers other
  than %s in the text or std_label attributes.

* Vend::SQL_Parser required LIMIT clause to be lowercase when it should be
  case-insensitive.

* Issue error message if subroutine for PREFIX-exec is missing.

* Fix [on-match]/[no-match] for loop lists without matchlimit generated from
  embedded Perl objects
    
* Fixed problem where both set_row() and set_slice() would try to get the key
  from last_sequence_value() for returning even if we already know the key and
  even on an UPDATE which can cause problems.

* New "timecard" round-robin style counters added with the timecard_stamp and
  timecard_read subs in Util.pm.  These are now used for better control of the
  session per IP lockouts (when RobotLimit is set).  See CVS log for more
  details (#2).

* lockout specialsubs will now override session per IP lockouts properly (#3).

* Fixed error where the wrong tag name can sometimes appear in [calc] error
  messages (#7).

* Superfluous Vend::Interpolate::sort_cart function removed (#70).

* set_slice now skips updates on existing records when we have only key
  columns (#98).

* Change [shipping-desc] to allow access to arbitrary keys in the shipping
  configuration.

* Fixed problem where only the last shipping policy will get stored if the
  multi-line format is used in shipping.asc.

* Fixed problem where options are not converted and stored properly on all
  shipping policies.

* Moved more code into the new process_new_beginning sub and cleaned up other
  code in Ship.pm.

* Added "file" (readable file) and "executable" (executable file) as extra
  Require directive tests.

* Added a new TABLE_COMMENT modifier to the Database directive to allow
  a short comment to be attached to MySQL and PostgreSQL tables.

* Delay "Server started" message as long as possible.

* Disable SOAP and display error when Vend::SOAP fails to load (#46).

* Remove catalog status files when removing catalog. Also call remove_catalog at
  server stop -- would be nice for cleanup anyway (#95).

* Fixed problem where RPC mode would fork too many processes at startup due to
  race condition (#107).

* Set $0 throughout the server and dispatch process to reflect current
  conditions (#107).

* Set up more aggressive management in response to INT or TERM to propagate the
  request down to the children. Prior to this arrangement, a restart or kill
  would leave many of the children running. This cleaned up Interchange stops
  to remove all preforked daemons (#107).

* Adjusted housekeeping to cull out old pids so that PIDcheck was enforced in
  PreFork (#107).

* Pass $opt to labeled_list fixing behaviour of fly-list to be matching other 
  x-list tags (#89).

* Pass applylocale option into Vend::Form::options_to_array in order to
  localize option labels (#80).

* New set_process_name sub which is used to change the status in the process
  name indicator.

* Fixed problem where form values do not always default to the $Values hash
  values for corresponding form fields when defaults=1 and wizard=1 are both
  set in the table editor.

* Fixed a bug where the [data session host] was not being set on a session's
  first page access.  The "host" key was only being set for subsequent pages.

* Removed MV_DOLLAR_ZERO workaround for a bug fixed 5 years ago.

* Added a new "scratchd" test type.  This is the same as "scratch" except
  that it deletes the variable from the scratchpad after testing.

UserDB
------

* Fixed UserDB login issues within embedded Perl by using
  Vend::Util::string_to_ref for deserialization of carts and other 
  hashes.  

* New validchars option to customize valid characters for usernames, e.g.
  adding the + character to the list of valid characters:

  UserDB    default    validchars "-A-Za-z0-9_@.+"

UserTag
-------

* Make [save-cart] keep cart if userdb returns with an error. 

* Make [formel] call [display] on unknown types.

* Fixed cleanse option of [import-fields] for composite keys (#98).

Filter
------

* Added "round" filter to round in floating-point-safe way, using the
  Vend::Util routine.

* Avoid ambiguity between two time formats in date_change filter.

* Added "lspace2nbsp" filter. Translates leading spaces to nbsp

Checks
------

* Added "match" check to match another CGI variable, e.g. for password
  verification.

Payment
-------

* New NetBilling module.

Jobs
----

* Added new job group db with export job to export databases offline for
  backup and version control purposes.

* Added process ID to "Run jobs" and "Finished jobs" log messages for better
  troubleshooting.

* Avoid cluttering global log file with job run messages.

* Allow parameters passed to jobs, acknowledges --email commandline option
  now (#103).
 
UI
--

* Fix page banner in menu editor.

* Tidied up some code in customer_mailing.html

* Fixed test to see if sku exists on creation of new item 
  in quick_question.html (#17)

* Avoid crashes on table export if data contains Interchange tags (#100).

Standard demo
-------------

* Fixed minor security hole of admin's session ID being exposed when placing
  an order in the admin. Found by Mark Lipscombe <markl@gasupnow.com>.

* Various special_pages/missing.html fixes:
  - Fixed broken admin 404 error page (which came from Standard).
  - Removed duplicate, sometimes-bogus MV_PREV_PAGE display.
  - Eliminated double-interpolation of page comparison.

* Updated Discover Card logo. Provided by Steve Graham.

* Increased compatibility with XHTML.

* Cleaned up splash page and fixed broken links.

* Add CVV2 support to checkout pages, images thanks to Jure Kodzoman.

* Fix problem with permanently setting members_only, bug and fix found
  by Jo-Ellen Matthews.

SOAP
----

* Return proper SOAP error to the client instead of disclosing our faults.

Packaging
---------

* Switched from dh_movefiles to dh_install for Debian packaging.

* Added --oknodo option to start-stop-daemon for restart action in the
  Debian init script (#28).

Other
-----

* Updated copyright in headers to 2007 (#102).
